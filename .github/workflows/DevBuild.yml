name: DevBuild

on: 
  pull_request:
    branches: [ main,master ]
  workflow_dispatch:
  
jobs:
 
 build:
    runs-on: self-hosted
    
    steps:  
    - name: Check file existence
      id: check_files
      uses: andstor/file-existence-action@v1
      with:
        files: "C:/Work/WUG/Main"
   
    - name: Clone Repo
      if: steps.check_files.outputs.files_exists == 'false'
      shell: cmd
      run: git clone https://${{ secrets.TOKEN }}@github.bedford.progress.com/sgurram/WUG C:/Work/WUG/Main     
      
    - name: pull Repo
      if: steps.check_files.outputs.files_exists == 'true'
      working-directory: C:\Work\WUG\Main\
      shell: cmd
      run: git pull  
           
#     - name: Run Devbuild
#       working-directory: C:\Work\WUG\Main\Source\DevBuildTools
#       shell: cmd
#       run: DevBuild.bat
        
    - name: Check Build status
      id: BuildStatus
      working-directory: C:\work\WUG\Main\Source\DevBuildTools
      shell: cmd
      run: |
             findstr -ri abort DevBuild.log | set %errorlevel% = 0
             set %errorlevel% = 0
#       continue-on-error: true
   
#     - name: Abort if Build gets failed
#       if: steps.BuildStatus.status == failure() 
#       run: exit 0
       
    - name: Trigger next workflow
      if: success()
      uses: peter-evans/repository-dispatch@v1
      with:
        token: ${{ secrets.REPO_GHA_PAT }}
        repository: ${{ github.repository }}
        event-type:  RunTests
        client-payload: '{"ref": "${{ github.ref }}", "sha": "${{ github.sha }}"}'         


      
